package UniCache

import chisel3._
import chisel3.util._
import chisel3.iotesters.PeekPokeTester
import firrtl_interpreter._
import scala.collection.mutable.ListBuffer
import scala.sys.process._
import scala.util.control._
import scala.collection.mutable.Queue

object Hw5Tests {

  val compulsoryReadMissTest = Queue(
    Request("b1", "b0", "xC00", "x100")
  )
  val compulsoryWriteMissTest = Queue(
    Request("b1", "b1", "xC00", "x100")
  )
  val writebackTest = Queue(
    Request("b1", "b1", "xC00", "x100"),
    Request("b1", "b1", "xC04", "x101"),
    Request("b1", "b1", "xC08", "x102"),
    Request("b1", "b1", "xC0c", "x103"),
    Request("b1", "b0", "xD00", "x103"),
    Request("b1", "b0", "xC00", "x103")
  )
  val readConfilctMissTest = Queue(
    Request("b1", "b1", "xC00", "x100"),
    Request("b1", "b1", "xD00", "x200"),
    Request("b1", "b0", "xC00", "x100"),
    Request("b1", "b0", "xD00", "x100"),
  )
  val logTest = Queue(
    Request("b1", "b1", "xC04", "x100"),
    Request("b1", "b1", "xC18", "x101"),
    Request("b1", "b1", "xC20", "x101"),
    Request("b1", "b1", "xC30", "x102"),
    Request("b1", "b1", "xD00", "x103"),
    Request("b1", "b1", "xC00", "x104")
  )

  val tests = List(
    ("compulsoryReadMissTest", compulsoryReadMissTest,
"""
cache state changes:
initially:
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 0, addr: c00, wdata: 100: (resp: )
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
--------------------------------------------------------------------------------
"""),
    ("compulsoryWriteMissTest", compulsoryWriteMissTest,
"""
cache state changes:
initially:
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c00, wdata: 100: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
--------------------------------------------------------------------------------
"""),
    ("writebackTest", writebackTest,
"""
cache state changes:
initially:
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c00, wdata: 100: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c04, wdata: 101: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000101 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c08, wdata: 102: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 0000000000000102 | 0000000000000101 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c0c, wdata: 103: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 0000000000000103 | 0000000000000102 | 0000000000000101 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 0, addr: d00, wdata: 103: (resp: fff00c0)
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   34 | [ 1 ] | 000000000FFF00D0 | 000000000FFF00D0 | 000000000FFF00D0 | 000000000FFF00D0
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 0, addr: c00, wdata: 103: (resp: fff00d0)
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 0000000000000103 | 0000000000000102 | 0000000000000101 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
--------------------------------------------------------------------------------
"""),
    ("readConfilctMissTest", readConfilctMissTest,
"""
cache state changes:
initially:
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c00, wdata: 100: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: d00, wdata: 200: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   34 | [ 1 ] | 000000000FFF00D0 | 000000000FFF00D0 | 000000000FFF00D0 | 0000000000000200
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 0, addr: c00, wdata: 100: (resp: fff00d0)
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 0, addr: d00, wdata: 100: (resp: 100)
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   34 | [ 1 ] | 000000000FFF00D0 | 000000000FFF00D0 | 000000000FFF00D0 | 0000000000000200
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
--------------------------------------------------------------------------------
"""),
    ("logTest", logTest,
"""
cache state changes:
initially:
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c04, wdata: 100: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100 | 000000000FFF00C0
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c18, wdata: 101: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100 | 000000000FFF00C0
   30 | [ 1 ] | 000000000FFF00C1 | 0000000000000101 | 000000000FFF00C1 | 000000000FFF00C1
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c20, wdata: 101: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100 | 000000000FFF00C0
   30 | [ 1 ] | 000000000FFF00C1 | 0000000000000101 | 000000000FFF00C1 | 000000000FFF00C1
   30 | [ 1 ] | 000000000FFF00C2 | 000000000FFF00C2 | 000000000FFF00C2 | 0000000000000101
    0 | [ 0 ] | 0000000000000000 | 0000000000000000 | 0000000000000000 | 0000000000000000
after valid: 1, write: 1, addr: c30, wdata: 102: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100 | 000000000FFF00C0
   30 | [ 1 ] | 000000000FFF00C1 | 0000000000000101 | 000000000FFF00C1 | 000000000FFF00C1
   30 | [ 1 ] | 000000000FFF00C2 | 000000000FFF00C2 | 000000000FFF00C2 | 0000000000000101
   30 | [ 1 ] | 000000000FFF00C3 | 000000000FFF00C3 | 000000000FFF00C3 | 0000000000000102
after valid: 1, write: 1, addr: d00, wdata: 103: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   34 | [ 1 ] | 000000000FFF00D0 | 000000000FFF00D0 | 000000000FFF00D0 | 0000000000000103
   30 | [ 1 ] | 000000000FFF00C1 | 0000000000000101 | 000000000FFF00C1 | 000000000FFF00C1
   30 | [ 1 ] | 000000000FFF00C2 | 000000000FFF00C2 | 000000000FFF00C2 | 0000000000000101
   30 | [ 1 ] | 000000000FFF00C3 | 000000000FFF00C3 | 000000000FFF00C3 | 0000000000000102
after valid: 1, write: 1, addr: c00, wdata: 104: 
 Tag  | Valid |     Data (Slot3) |     Data (Slot2) |     Data (Slot1) |     Data (Slot0)
   30 | [ 1 ] | 000000000FFF00C0 | 000000000FFF00C0 | 0000000000000100 | 0000000000000104
   30 | [ 1 ] | 000000000FFF00C1 | 0000000000000101 | 000000000FFF00C1 | 000000000FFF00C1
   30 | [ 1 ] | 000000000FFF00C2 | 000000000FFF00C2 | 000000000FFF00C2 | 0000000000000101
   30 | [ 1 ] | 000000000FFF00C3 | 000000000FFF00C3 | 000000000FFF00C3 | 0000000000000102
--------------------------------------------------------------------------------
""")
  )
}
